<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BitShade-Pro — Private BTC → Starknet Bridge</title>
<meta name="description" content="BitShade-Pro: Private BTC → Starknet bridge — Merkle proofs, nullifiers, encrypted backups." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#06121a; --panel:#0b1722; --muted:#9fb0c6; --accent:#7c5cff; --accent-2:#4f46e5;
    --glass:rgba(255,255,255,0.02); --accent-glow:rgba(124,92,255,0.18);
    --ok:#16a34a; --bad:#ef4444;
    --card-shadow:0 8px 32px rgba(2,6,23,0.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(ellipse at top,#0f1f2f 0%,#02121a 50%,#000 100%);color:#e6eef8}
  .wrap{max-width:1200px;margin:20px auto;padding:18px;position:relative}
  header{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;margin-bottom:18px;background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0;font-size:22px;line-height:1.05;background:linear-gradient(135deg,#fff,#a78bfa);-webkit-background-clip:text;color:transparent}
  .lead{margin:6px 0 0;color:var(--muted);font-size:13px}
  .top-stats{display:flex;gap:12px;align-items:center}
  .stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;min-width:110px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
  .stat .small{font-size:12px;color:var(--muted)}
  .stat .big{font-weight:700;font-family:JetBrains Mono,monospace}
  .mode-toggle{display:flex;gap:8px}
  .mode-toggle button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
  .mode-toggle button.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#fff;box-shadow:0 6px 24px var(--accent-glow)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  .card{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
  h3{margin:0;font-size:16px}
  .card-sub{color:var(--muted);font-size:13px;margin-top:6px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.3);color:inherit;font-size:14px}
  button.primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  .mono{font-family:JetBrains Mono,monospace}
  .small{font-size:13px;color:var(--muted)}
  .tiny{font-size:12px;color:var(--muted)}
  .info{padding:10px;border-radius:8px;background:rgba(124,92,255,0.04);border:1px solid rgba(124,92,255,0.06);color:#cdb6ff;font-size:13px}
  .list{max-height:260px;overflow:auto}
  .log{height:180px;overflow:auto;background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .tx{padding:10px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));margin-bottom:8px}
  .node{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);margin:6px;font-family:JetBrains Mono,monospace;cursor:pointer}
  .node.leaf{background:linear-gradient(90deg,#072a36,#08364a);border-color:rgba(8,54,74,0.6)}
  .node.root{background:linear-gradient(90deg,#243bff,#7c5cff);color:#fff;font-weight:700}
  .tree-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .search{display:flex;gap:8px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  /* modal / overlay / toast */
  .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.75);align-items:center;justify-content:center;padding:24px;z-index:1200}
  .modal .panel{background:var(--panel);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:100%;max-width:760px}
  .tour-step{display:flex;flex-direction:column;gap:12px}
  .toast-wrap{position:fixed;right:20px;bottom:20px;z-index:1300;display:flex;flex-direction:column;gap:8px}
  .toast{background:#0f1720;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 20px rgba(0,0,0,0.6);color:#e6eef8}
  /* accessibility focus */
  :focus{outline:2px solid rgba(124,92,255,0.22);outline-offset:2px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} header{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap" role="application" aria-labelledby="app-title">
  <header>
    <div>
      <h1 id="app-title">BitShade-Pro</h1>
      <div class="lead">Private, non-custodial BTC → Starknet bridge with Merkle proofs, nullifier registry and encrypted backups.</div>
      <div class="tiny" style="margin-top:8px;color:var(--muted)">Complete flow: deposit → inspect proof → withdraw → export proof. Secrets are session-only unless exported encrypted.</div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <div class="top-stats" aria-hidden="false">
        <div class="stat"><div class="small">BTC Balance</div><div id="btcBal" class="big mono">0.500000</div></div>
        <div class="stat"><div class="small">wSTRK</div><div id="wBal" class="big mono">0.0000</div></div>
        <div class="stat"><div class="small">Pool</div><div id="poolCount" class="big mono">0</div></div>
      </div>
      <div class="mode-toggle" role="tablist" aria-label="Mode toggle">
        <button id="modeBegin" class="active" aria-pressed="true">Beginner</button>
        <button id="modeAdv" aria-pressed="false">Advanced</button>
        <button id="startTour" class="ghost" title="Start guided tour">Guided tour</button>
      </div>
    </div>
  </header>

  <div class="grid" role="main" aria-label="Main application">
    <!-- left -->
    <main>
      <section class="card" aria-labelledby="onboard-title" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="onboard-title">Quick start</h3>
            <div class="card-sub">Follow the checklist to create and spend a private note. Backups are encrypted and manual.</div>
          </div>
          <div><button id="btnSkipOnboard" class="ghost">Skip</button></div>
        </div>

        <div id="onboardChecks" style="margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <div class="badge">Deposits: <span id="statsDeposits">0</span></div>
          <div class="badge">Withdrawals: <span id="statsWithdraws">0</span></div>
          <div class="badge">Proofs: <span id="statsProofs">0</span></div>
        </div>
      </section>

      <section class="card" style="margin-bottom:14px" aria-labelledby="deposit-title">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3 id="deposit-title">Deposit — create private note</h3><div class="card-sub">Create a note to represent wrapped BTC (wSTRK).</div></div>
          <div><select id="bridgeSelect" aria-label="Bridge provider" class="ghost" style="background:transparent;color:var(--muted)"><option>Alpen / Glock</option><option>Atomiq</option><option>Garden</option></select></div>
        </div>

        <div style="margin-top:12px" class="row">
          <div style="flex:1"><label for="depositAmount">Amount (BTC)</label><input id="depositAmount" type="number" step="0.001" placeholder="0.01" /></div>
          <div style="width:140px">
            <label for="depositPreset">Preset</label>
            <select id="depositPreset"><option value="">Select</option><option value="0.01">0.01</option><option value="0.05">0.05</option><option value="0.1">0.1</option></select>
          </div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button id="btnDeposit" class="primary">Create note</button>
          <button id="btnBatchDeposit" class="ghost">Batch (3 × 0.01)</button>
          <button id="btnExportEnc" class="ghost">Export backup</button>
          <button id="btnImportEnc" class="ghost">Import backup</button>
          <button id="btnReset" class="ghost">Reset state</button>
        </div>

        <div style="margin-top:12px" class="info small">Notes are generated client-side using Web Crypto. Backups are AES-GCM encrypted with PBKDF2 key derivation (200k iterations).</div>
      </section>

      <section class="card" style="margin-bottom:14px" aria-labelledby="withdraw-title">
        <h3 id="withdraw-title">Withdraw — spend private notes</h3>
        <div class="card-sub">Paste a note to spend directly or auto-select notes that cover an amount. Change notes are created automatically.</div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 260px;gap:12px">
          <div>
            <label for="noteInput">Paste note (optional)</label>
            <textarea id="noteInput" rows="2" placeholder="secret:leaf:amount"></textarea>
            <div style="height:8px"></div>
            <label for="withdrawAmount">Amount (wSTRK)</label>
            <input id="withdrawAmount" type="number" step="0.01" placeholder="0.0" />
            <div style="height:8px"></div>
            <label for="destAddr">Destination address</label>
            <input id="destAddr" placeholder="0x..." value="0xDEADBEEF" />
            <div style="margin-top:8px">
              <label class="small"><input id="checkboxGasless" type="checkbox" /> Use paymaster (gasless)</label>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnAutoSelect" class="ghost">Auto-select</button>
              <button id="btnWithdraw" class="primary">Withdraw</button>
              <button id="btnVerifyProof" class="ghost">Verify proof</button>
              <button id="btnShowTx" class="ghost">Export last proof</button>
            </div>

            <div id="withdrawNote" class="tiny" style="margin-top:12px;color:var(--muted)"></div>
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small">Selected notes</div>
              <div style="display:flex;gap:8px">
                <input id="notesSearch" placeholder="search notes..." class="tiny" style="padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted)" />
                <button id="btnClearSelection" class="ghost">Clear</button>
              </div>
            </div>
            <div id="notesForSelect" class="list mono" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="activity-title">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3 id="activity-title">Activity & receipts</h3><div class="card-sub">Chronological activity — export proofs for audit.</div></div>
          <div><button id="clearLog" class="ghost">Clear log</button></div>
        </div>
        <div id="txLog" class="log" role="log" aria-live="polite"></div>
      </section>
    </main>

    <!-- right -->
    <aside>
      <section class="card" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3>Pool inspector</h3><div class="card-sub">Merkle leaves (SHA-256)</div></div>
          <div style="display:flex;gap:8px">
            <button id="merklePrev" class="ghost">Prev</button>
            <button id="merkleNext" class="ghost">Next</button>
          </div>
        </div>

        <div class="merkle-canvas" style="margin-top:12px">
          <div class="root-display"><div style="font-size:12px;color:rgba(255,255,255,0.9)">MERKLE ROOT</div><div id="root" class="mono root-value" style="margin-top:6px">—</div></div>
          <div class="tiny" style="color:var(--muted)">Pool size: <span id="poolSize">0</span></div>
          <div id="merkleViz" style="margin-top:12px;min-height:120px"></div>
          <div style="margin-top:12px">
            <button id="btnSyncRootOnChain" class="primary">Sync root → Starknet</button>
            <button id="btnCheckOnChain" class="ghost">Check on-chain root</button>
          </div>
          <div id="onchainStatus" class="tiny" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </section>

      <section class="card" style="margin-bottom:12px">
        <h3>My notes</h3>
        <div class="tiny" style="color:var(--muted)">Notes remain in memory during this session. Export if you need persistence.</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <input id="noteFilter" placeholder="filter notes..." class="tiny" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted)"/>
          <button id="noteExportAll" class="ghost">Export all</button>
        </div>
        <div id="myNotes" class="list" style="margin-top:12px"></div>
      </section>

      <section class="card">
        <h3>Nullifiers (spent)</h3>
        <div id="nulls" class="mono tiny" style="max-height:140px;overflow:auto;color:var(--muted);margin-top:8px">none</div>
      </section>
    </aside>
  </div>

  <footer>BitShade-Pro — Non-custodial, privacy-minded BTC → Starknet UX. Designed for secure, auditable transfers.</footer>
</div>

<!-- Modals -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="panel" role="document" aria-modal="true">
    <div id="modalContent"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="modalClose" class="ghost">Close</button></div>
  </div>
</div>

<!-- Guided tour modal -->
<div id="tourModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="tour-step">
      <h3>Guided tour</h3>
      <div class="small" id="tourText">Step 1: Create a private note with Deposit.</div>
      <div style="display:flex;justify-content:space-between">
        <div><button id="tourPrev" class="ghost">Prev</button></div>
        <div style="display:flex;gap:8px">
          <button id="tourNext" class="primary">Next</button>
          <button id="tourEnd" class="ghost">End tour</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toasts" class="toast-wrap" aria-live="polite"></div>

<script>
/* BitShade-Pro — UI-only file with UX improvements
   - Secrets (notes) stay in memory unless user exports encrypted backup
   - Added: guided tour, toasts, note search/filter, merkle pagination, keyboard shortcuts
   - All primary functionality retained: deposit, withdraw, merkle proof generation/verify, encrypted export/import, nullifier registry, tx log
*/

// ----------------- Utilities -----------------
const $ = id => document.getElementById(id);
function nowISO(){ return new Date().toISOString(); }
function buf2hex(buffer){ const bytes = new Uint8Array(buffer); return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function sha256Hex(text){ const enc = new TextEncoder(); const data = enc.encode(text); const h = await crypto.subtle.digest('SHA-256', data); return buf2hex(h); }
function randB64(len=32){ const a = crypto.getRandomValues(new Uint8Array(len)); let s=''; for(let i=0;i<a.length;i++) s += String.fromCharCode(a[i]); return btoa(s); }
function downloadText(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
function copyToClipboard(text){ return navigator.clipboard?.writeText(text).then(()=>showToast('Copied to clipboard')).catch(()=>showToast('Copy failed','error')); }
function showToast(msg, level='info', ttl=3500){ const wrap = $('toasts'); const t = document.createElement('div'); t.className='toast'; t.textContent = msg; if(level==='error') t.style.borderColor='var(--bad)'; wrap.appendChild(t); setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),400); }, ttl); }

// ----------------- Persistence (public-only) -----------------
const PUBLIC_KEY = 'bitshade_pro_public_v6';
function savePublic(state){ try{ const pub = { btcBalance: state.btcBalance, wBalance: state.wBalance, leaves: state.leaves, nulls: state.nulls, txs: state.txs }; localStorage.setItem(PUBLIC_KEY, JSON.stringify(pub)); }catch(e){ console.warn(e); } }
function loadPublic(){ try{ const raw = localStorage.getItem(PUBLIC_KEY); if(!raw) return null; return JSON.parse(raw); }catch(e){ return null; } }

// ----------------- App state -----------------
let state = {
  btcBalance: 0.5,
  wBalance: 0.0,
  notes: [],    // secret:leaf:amount (session-only)
  leaves: [],   // array of leaf strings
  nulls: [],    // spent nullifiers
  txs: []       // transaction log entries
};
// load persisted public state only
const persisted = loadPublic();
if(persisted){ state.btcBalance = persisted.btcBalance ?? state.btcBalance; state.wBalance = persisted.wBalance ?? state.wBalance; state.leaves = persisted.leaves ?? state.leaves; state.nulls = persisted.nulls ?? state.nulls; state.txs = persisted.txs ?? state.txs; }

// ----------------- UI helpers -----------------
function uiLog(msg, lvl='info'){ const log = $('txLog'); const el = document.createElement('div'); el.className='tx'; el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong class="mono">${(new Date()).toLocaleTimeString()}</strong></div></div><div style="margin-top:8px">${escapeHtml(msg)}</div>`; if(lvl==='error') el.style.borderColor='var(--bad)'; log.prepend(el); }
function pushTx(type, summary, meta={}){ const tx = { type, time: nowISO(), summary, meta: {...meta, txhash: meta.txhash || fakeTxHash()} }; state.txs.push(tx); savePublic(state); renderTxs(); uiLog(`${type}: ${summary}`); return tx; }
function fakeTxHash(){ const r = crypto.getRandomValues(new Uint8Array(16)); return '0x'+Array.from(r).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

// ----------------- Renderers -----------------
function renderAll(){ $('btcBal').textContent = state.btcBalance.toFixed(6); $('wBal').textContent = state.wBalance.toFixed(4); $('poolCount').textContent = state.leaves.length; $('poolSize').textContent = state.leaves.length; renderNotes(); renderLeaves(); renderNulls(); renderRoot(); renderTxs(); renderOnboard(); }
function renderNotes(filter=''){
  const box = $('myNotes'); box.innerHTML=''; const f = (filter||'').toLowerCase();
  if(!state.notes.length){ box.innerHTML = '<div class="small" style="color:var(--muted)">No notes stored in this session.</div>'; return; }
  state.notes.forEach((n, idx) => {
    if(f && !n.toLowerCase().includes(f)) return;
    const [secret,leaf,amt] = n.split(':');
    const div = document.createElement('div'); div.className='note-card';
    div.innerHTML = `<div class="mono">${leaf.slice(0,16)}... — <span class="small">${amt} wSTRK</span></div>
      <div style="margin-top:8px;display:flex;gap:8px"><button class="ghost" data-copy="${idx}">Copy</button><button class="ghost" data-reveal="${idx}">Reveal</button><button class="ghost" data-dl="${idx}">Download</button></div>`;
    box.appendChild(div);
  });
  box.querySelectorAll('[data-copy]').forEach(b=>b.onclick=()=>{ const i=Number(b.getAttribute('data-copy')); copyToClipboard(state.notes[i]); });
  box.querySelectorAll('[data-dl]').forEach(b=>b.onclick=()=>{ const i=Number(b.getAttribute('data-dl')); downloadText(`note-${i}.txt`, state.notes[i]); });
  box.querySelectorAll('[data-reveal]').forEach(b=>b.onclick=()=>{ const i=Number(b.getAttribute('data-reveal')); showModalContent('Note', `<pre style="background:rgba(0,0,0,0.3);padding:8px;border-radius:6px">${escapeHtml(state.notes[i])}</pre>`); });
}
function renderLeaves(page=0){
  const perPage = 32;
  const box = $('merkleViz'); box.innerHTML='';
  if(!state.leaves.length){ box.innerHTML = '<div class="small" style="color:var(--muted)">No leaves</div>'; return; }
  const totalPages = Math.ceil(state.leaves.length / perPage);
  page = Math.max(0, Math.min(page, totalPages-1));
  const start = page * perPage; const slice = state.leaves.slice(start, start+perPage);
  const levels = buildTreeLevels(slice);
  levels.forEach((lvl, li) => {
    const row = document.createElement('div'); row.className='tree-row';
    lvl.forEach((node,i)=>{
      const nd = document.createElement('div'); nd.className='node ' + (li===0? 'leaf' : (li===levels.length-1 ? 'root' : '')); nd.textContent = node.slice(0,12) + (node.length>12 ? '...' : ''); nd.onclick=()=> highlightPath(li,i,levels); row.appendChild(nd);
    });
    box.appendChild(row);
  });
  // pagination info
  const pager = document.createElement('div'); pager.className='tiny'; pager.style.marginTop='8px'; pager.style.color='var(--muted)'; pager.textContent = `Showing ${start+1}-${Math.min(start+perPage,state.leaves.length)} of ${state.leaves.length}`;
  box.appendChild(pager);
  // attach to global for prev/next
  merklePage = page;
}
let merklePage = 0;
function renderRoot(){ calcMerkleRoot(state.leaves).then(r=>{ $('root').textContent = r || '—'; }); }
function renderNulls(){ const el = $('nulls'); el.innerHTML = ''; if(!state.nulls.length){ el.innerHTML='<div class="small" style="color:var(--muted)">none</div>'; return; } state.nulls.forEach(n=>{ const d=document.createElement('div'); d.textContent = n.slice(0,16)+'...'; el.appendChild(d); }); }
function renderTxs(){ const box=$('txLog'); box.innerHTML=''; if(!state.txs.length){ box.innerHTML='<div class="small" style="color:var(--muted)">No activity yet</div>'; return; } state.txs.slice().reverse().forEach((t,idx)=>{ const el=document.createElement('div'); el.className='tx'; el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong class="mono">${t.type}</strong><span class="tiny" style="color:var(--muted);margin-left:8px">${t.time.split('T')[1].slice(0,8)}</span></div><div style="display:flex;gap:8px"><button class="ghost" data-copytx="${idx}">Copy</button><button class="ghost" data-dltx="${idx}">Download</button></div></div><div style="margin-top:8px" class="small">${escapeHtml(t.summary)}</div><div class="tiny" style="color:var(--muted);margin-top:8px">tx: <span class="mono">${t.meta.txhash}</span></div>`; box.appendChild(el); }); box.querySelectorAll('[data-copytx]').forEach(b=>b.onclick=()=>{ const i=Number(b.getAttribute('data-copytx')); copyToClipboard(JSON.stringify(state.txs.slice().reverse()[i])); }); box.querySelectorAll('[data-dltx]').forEach(b=>b.onclick=()=>{ const i=Number(b.getAttribute('data-dltx')); const tx=state.txs.slice().reverse()[i]; downloadText(`tx-${i}.json`, JSON.stringify(tx,null,2)); });
}

// ----------------- Merkle helpers -----------------
async function calcMerkleRoot(leaves){
  if(!leaves.length) return '';
  let level = leaves.slice();
  while(level.length > 1){
    const next = [];
    for(let i=0;i<level.length;i+=2){
      const a=level[i]; const b=(i+1<level.length)?level[i+1]:level[i];
      next.push(await sha256Hex(a + b));
    }
    level = next;
  }
  return level[0];
}
async function makeMerkleProof(leaves,index){
  let idx=index; let level=leaves.slice(); const proof=[];
  while(level.length>1){
    const siblingIndex = (idx%2===0) ? idx+1 : idx-1;
    const sibling = (siblingIndex<level.length) ? level[siblingIndex] : level[idx];
    proof.push({ sibling, isLeft:(idx%2===1) });
    const next=[];
    for(let i=0;i<level.length;i+=2){
      const a=level[i]; const b=(i+1<level.length)?level[i+1]:level[i];
      next.push(await sha256Hex(a + b));
    }
    level = next; idx = Math.floor(idx/2);
  }
  return proof;
}
async function verifyMerkleProof(leaf, proof, root, index){
  let computed = leaf; let idx = index;
  for(const step of proof){
    if(idx % 2 === 0) computed = await sha256Hex(computed + (step.sibling || computed));
    else computed = await sha256Hex((step.sibling || computed) + computed);
    idx = Math.floor(idx/2);
  }
  return computed === root;
}
function buildTreeLevels(leaves){
  if(!leaves.length) return [];
  const levels=[]; let level=leaves.slice(); levels.push(level.slice());
  while(level.length>1){
    const next=[];
    for(let i=0;i<level.length;i+=2){ const a=level[i]; const b=(i+1<level.length)?level[i+1]:level[i]; next.push((a.slice(0,8)+'+'+b.slice(0,8)).slice(0,16)); }
    level = next; levels.push(level.slice());
  }
  return levels;
}
function highlightPath(levelIndex, nodeIndex, levels){
  const rows = document.querySelectorAll('#merkleViz .tree-row'); rows.forEach(r=>r.querySelectorAll('.node').forEach(n=>n.classList.remove('active')));
  let idx = nodeIndex;
  for(let li=0;li<levels.length;li++){
    const row = rows[li]; if(!row) continue;
    const nodes = row.querySelectorAll('.node'); const node = nodes[idx]; if(node) node.classList.add('active'); idx = Math.floor(idx/2);
  }
  showToast(`Inspecting leaf #${nodeIndex}`);
}

// ----------------- Business logic -----------------
const RATE = 1000;
async function createNoteForAmount(wAmount){
  const secret = randB64(32);
  const leaf = await sha256Hex(secret);
  return `${secret}:${leaf}:${wAmount}`;
}
async function deposit(amountBTC){
  amountBTC = Number(amountBTC);
  if(!amountBTC || amountBTC <= 0){ showToast('Invalid deposit amount','error'); return null; }
  if(amountBTC > state.btcBalance){ showToast('Insufficient BTC','error'); return null; }
  const w = Number((amountBTC * RATE).toFixed(6));
  const note = await createNoteForAmount(w);
  state.notes.push(note);
  state.leaves.push(note.split(':')[1]);
  state.btcBalance = Number((state.btcBalance - amountBTC).toFixed(6));
  state.wBalance = Number((state.wBalance + w).toFixed(6));
  const tx = pushTx('DEPOSIT', `Deposited ${amountBTC} BTC → ${w} wSTRK. Note created.`, { noteId: state.notes.length-1 });
  try{ await navigator.clipboard.writeText(note); showToast('Note copied to clipboard'); }catch(e){}
  savePublic(state); renderAll();
  return note;
}
function autoSelectNotes(amount){
  amount = Number(amount);
  const available = state.notes.map((n,idx)=>{ const parts=n.split(':'); return { idx, note:n, leaf:parts[1], amt:Number(parts[2]) }; });
  available.sort((a,b)=>b.amt - a.amt);
  const picked=[]; let sum=0;
  for(const a of available){ if(sum>=amount) break; picked.push(a); sum+=a.amt; }
  if(sum < amount) return null;
  return { picked, sum };
}
async function withdrawWithNote(noteStr, dest, gasless=false){
  if(!noteStr){ showToast('Note required','error'); return null; }
  const parts = noteStr.split(':'); if(parts.length<3){ showToast('Bad note format','error'); return null; }
  const secret=parts[0], leaf=parts[1], amt=Number(parts[2]);
  const idx = state.leaves.indexOf(leaf);
  if(idx===-1){ showToast('Note not found in pool','error'); return null; }
  const proof = await makeMerkleProof(state.leaves, idx);
  const root = await calcMerkleRoot(state.leaves);
  const nullifier = await sha256Hex('null:' + noteStr);
  if(state.nulls.includes(nullifier)){ showToast('Nullifier already used','error'); return null; }
  const ok = await verifyMerkleProof(leaf, proof, root, idx);
  if(!ok){ showToast('Proof verification failed','error'); return null; }
  state.nulls.push(nullifier);
  state.leaves.splice(idx,1);
  const noteIdx = state.notes.indexOf(noteStr); if(noteIdx!==-1) state.notes.splice(noteIdx,1);
  state.wBalance = Number((state.wBalance - amt).toFixed(6));
  const tx = pushTx('WITHDRAW', `Withdraw ${amt} wSTRK → ${dest}. Gasless:${gasless}`, { nullifier, proofLen: proof.length });
  savePublic(state); renderAll(); return tx;
}
async function withdrawAmount(amount, dest, gasless=false){
  amount = Number(amount);
  if(isNaN(amount) || amount <= 0){ showToast('Invalid withdraw amount','error'); return null; }
  if(amount > state.wBalance){ showToast('Insufficient wrapped balance','error'); return null; }
  const selection = autoSelectNotes(amount);
  if(!selection){ showToast('Insufficient notes to cover amount','error'); return null; }
  for(const p of selection.picked){
    const n = p.note; const nullifier = await sha256Hex('null:' + n); state.nulls.push(nullifier);
    const leaf = p.leaf; const li = state.leaves.indexOf(leaf); if(li!==-1) state.leaves.splice(li,1);
    const ni = state.notes.indexOf(n); if(ni!==-1) state.notes.splice(ni,1);
  }
  const sum = selection.sum; const change = Number((sum - amount).toFixed(6));
  if(change > 0.000001){ const cn = await createNoteForAmount(change); state.notes.push(cn); state.leaves.push(cn.split(':')[1]); showToast(`Change note created: ${change} wSTRK`); }
  state.wBalance = Number((state.wBalance - amount).toFixed(6));
  pushTx('WITHDRAW', `Withdraw ${amount} wSTRK → ${dest} (used ${selection.picked.length} notes)`);
  savePublic(state); renderAll(); return true;
}

// ----------------- Encrypted export/import -----------------
async function exportEncrypted(password){
  if(!password){ showToast('Password required','error'); return; }
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), { name:'PBKDF2' }, false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:200000, hash:'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, true, ['encrypt']);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = enc.encode(JSON.stringify(state));
  const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, data);
  const payload = { s: btoa(String.fromCharCode(...salt)), i: btoa(String.fromCharCode(...iv)), c: btoa(String.fromCharCode(...new Uint8Array(ct))) };
  downloadText('bitshade_backup_enc.json', JSON.stringify(payload,null,2));
  showToast('Encrypted backup saved');
}
async function importEncryptedFile(file, password){
  try{
    const txt = await file.text(); const payload = JSON.parse(txt);
    const salt = Uint8Array.from(atob(payload.s), c=>c.charCodeAt(0));
    const iv = Uint8Array.from(atob(payload.i), c=>c.charCodeAt(0));
    const ct = Uint8Array.from(atob(payload.c), c=>c.charCodeAt(0));
    const keyMaterial = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), { name:'PBKDF2' }, false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:200000, hash:'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, true, ['decrypt']);
    const data = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);
    const obj = JSON.parse(new TextDecoder().decode(data));
    // restore both public and private
    state = obj;
    savePublic(state);
    renderAll();
    showToast('Encrypted backup imported');
  }catch(e){ showToast('Import failed: ' + (e.message||e), 'error'); }
}

// ----------------- On-chain placeholder -----------------
$('btnSyncRootOnChain')?.addEventListener('click', async ()=>{
  const root = await calcMerkleRoot(state.leaves);
  if(!root){ showToast('No root to sync','error'); return; }
  const tx = pushTx('SYNC', `Stored Merkle root on-chain: ${root.substr(0,12)}...`, { root, txhash: fakeTxHash() });
  $('onchainStatus').textContent = `On-chain root stored — tx ${tx.meta.txhash}`;
});
$('btnCheckOnChain')?.addEventListener('click', ()=>{
  const last = state.txs.slice().reverse().find(t=>t.type==='SYNC');
  if(!last){ showToast('No on-chain root found','error'); return; }
  $('onchainStatus').textContent = `On-chain root: ${last.meta.root.substr(0,12)}... tx:${last.meta.txhash}`;
  showToast('Checked on-chain root');
});

// ----------------- Wire UI events -----------------
$('depositPreset')?.addEventListener('change', ()=> $('depositAmount').value = $('depositPreset').value);
$('btnDeposit')?.addEventListener('click', async ()=>{ const amt = $('depositAmount').value || '0.01'; const n = await deposit(amt); if(n) { $('statsDeposits').textContent = Number($('statsDeposits').textContent||0) + 1; } });
$('btnBatchDeposit')?.addEventListener('click', async ()=>{ for(let i=0;i<3;i++){ await deposit(0.01); await new Promise(r=>setTimeout(r,120)); } $('statsDeposits').textContent = Number($('statsDeposits').textContent||0) + 3; showToast('Batch deposits completed'); });
$('btnAutoSelect')?.addEventListener('click', ()=>{ const amt = Number($('withdrawAmount').value || 0); if(!amt){ showToast('Enter amount first','error'); return; } const sel = autoSelectNotes(amt); if(!sel){ showToast('Auto-select failed','error'); return; } $('notesForSelect').innerHTML = sel.picked.map(p=>`#${p.idx} ${p.amt} wSTRK`).join('<br>'); showToast('Notes selected'); });
$('btnWithdraw')?.addEventListener('click', async ()=>{ const note = $('noteInput').value.trim(); const amt = $('withdrawAmount').value; const dest = $('destAddr').value || '0xDEADBEEF'; const gasless = $('checkboxGasless').checked; if(note){ const tx = await withdrawWithNote(note, dest, gasless); if(tx) $('statsWithdraws').textContent = Number($('statsWithdraws').textContent||0) + 1; return; } if(!amt){ showToast('Enter withdraw amount or paste note','error'); return; } const ok = await withdrawAmount(amt, dest, gasless); if(ok) $('statsWithdraws').textContent = Number($('statsWithdraws').textContent||0) + 1; });
$('btnVerifyProof')?.addEventListener('click', async ()=>{ const pasted = $('noteInput').value.trim(); if(!pasted){ showToast('Paste a note to verify','error'); return; } const parts = pasted.split(':'); const leaf = parts[1]; const idx = state.leaves.indexOf(leaf); if(idx === -1){ showToast('Leaf not found','error'); return; } const proof = await makeMerkleProof(state.leaves, idx); const root = await calcMerkleRoot(state.leaves); const ok = await verifyMerkleProof(leaf, proof, root, idx); showToast('Proof verify: ' + (ok ? 'OK' : 'FAILED')); $('statsProofs').textContent = Number($('statsProofs').textContent||0) + 1; });
$('btnShowTx')?.addEventListener('click', ()=>{ const last = state.txs.slice().reverse()[0]; if(!last){ showToast('No transactions','error'); return; } downloadText('proof_sample.json', JSON.stringify(last,null,2)); showToast('Proof exported'); });

// export/import
$('btnExportEnc')?.addEventListener('click', async ()=>{ const pw = prompt('Enter password to encrypt backup:'); if(!pw) return; await exportEncrypted(pw); });
$('btnImportEnc')?.addEventListener('click', ()=>{ const f=document.createElement('input'); f.type='file'; f.accept='.json'; f.onchange = e => { const file = e.target.files[0]; const pw = prompt('Password to decrypt:'); if(!pw) return; importEncryptedFile(file,pw); }; f.click(); });

// reset and clear log
$('btnReset')?.addEventListener('click', ()=> showConfirm('Reset public state and clear notes?', ()=>{ localStorage.removeItem(PUBLIC_KEY); state = { btcBalance:0.5, wBalance:0.0, notes:[], leaves:[], nulls:[], txs:[] }; renderAll(); showToast('State reset'); }));
$('clearLog')?.addEventListener('click', ()=>{ state.txs = []; savePublic(state); renderTxs(); showToast('Log cleared'); });

// merkle pagination
$('merklePrev')?.addEventListener('click', ()=>{ merklePage = Math.max(0, merklePage-1); renderLeaves(merklePage); });
$('merkleNext')?.addEventListener('click', ()=>{ merklePage = merklePage+1; renderLeaves(merklePage); });

// notes search and selection clear
$('noteFilter')?.addEventListener('input', e=> renderNotes(e.target.value));
$('notesSearch')?.addEventListener('input', e=> { const s = e.target.value.toLowerCase(); const matches = state.notes.filter(n=>n.toLowerCase().includes(s)); $('notesForSelect').innerHTML = matches.map((m,i)=>`${i} ${m.split(':')[2]} wSTRK`).join('<br>'); });
$('btnClearSelection')?.addEventListener('click', ()=>{ $('notesForSelect').innerHTML=''; });

// Export all notes (session-only) as encrypted backup (user action)
$('noteExportAll')?.addEventListener('click', ()=>{ const pw = prompt('Enter password to encrypt backup:'); if(!pw) return exportEncrypted(pw); });

// reveal and modal helpers
function showModalContent(title, html){ $('modalContent').innerHTML = `<h3>${escapeHtml(title)}</h3><div style="margin-top:8px">${html}</div>`; showModal('modal'); }
function showModal(id){ const m = $(id); if(!m) return; m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hideModal(id){ const m = $(id); if(!m) return; m.style.display='none'; m.setAttribute('aria-hidden','true'); }
$('modalClose')?.addEventListener('click', ()=> hideModal('modal'));

// confirm
function showConfirm(msg, okCb){ showModalContent('Confirm', `<div class="small">${escapeHtml(msg)}</div>`); const ok = document.createElement('button'); ok.textContent='Confirm'; ok.className='primary'; ok.onclick = ()=>{ hideModal('modal'); okCb && okCb(); }; const cancel = document.createElement('button'); cancel.textContent='Cancel'; cancel.className='ghost'; cancel.onclick = ()=> hideModal('modal'); const container = $('modalContent'); container.appendChild(document.createElement('div')); container.lastChild.appendChild(ok); container.lastChild.appendChild(cancel); }

// guided tour
const tourSteps = [
  { text: 'Welcome to the tour. We will cover deposit, inspect and withdrawal.' },
  { text: 'Deposit: create a private note that represents wrapped BTC on Starknet.' , action: ()=> document.querySelector('#depositAmount')?.focus() },
  { text: 'Pool inspector: review the Merkle root and leaves for inclusion.' , action: ()=> document.querySelector('#merkleViz')?.scrollIntoView({behavior:"smooth"}) },
  { text: 'Withdraw: paste note or auto-select notes to spend and create nullifier.' , action: ()=> document.querySelector('#noteInput')?.focus() },
  { text: 'Export: create an encrypted backup (AES-GCM + PBKDF2). Keep your password safe.' }
];
let tourIndex = 0;
function openTour(idx=0){ tourIndex = idx; updateTour(); showModal('tourModal'); }
function updateTour(){ $('#tourText').textContent = tourSteps[tourIndex].text; if(tourSteps[tourIndex].action) try{ tourSteps[tourIndex].action(); }catch(e){} }
$('startTour')?.addEventListener('click', ()=> openTour(0));
$('tourNext')?.addEventListener('click', ()=>{ tourIndex = Math.min(tourIndex+1,tourSteps.length-1); updateTour(); if(tourIndex===tourSteps.length-1) $('tourNext').textContent='Finish'; });
$('tourPrev')?.addEventListener('click', ()=>{ tourIndex = Math.max(0,tourIndex-1); updateTour(); });
$('tourEnd')?.addEventListener('click', ()=> hideModal('tourModal'));

// small helpers
function fakeTxHash(){ const r = crypto.getRandomValues(new Uint8Array(16)); return '0x'+Array.from(r).map(b=>b.toString(16).padStart(2,'0')).join(''); }

// ----------------- Load / render -----------------
function savePublic(s){ savePublicState(s); }
function savePublicState(s){ try{ const pub = { btcBalance: s.btcBalance, wBalance: s.wBalance, leaves: s.leaves, nulls: s.nulls, txs: s.txs }; localStorage.setItem(PUBLIC_KEY, JSON.stringify(pub)); }catch(e){ console.warn(e); } }
renderAll();

// ----------------- Keyboard shortcuts -----------------
window.addEventListener('keydown', (e)=>{
  if(e.key==='d'){ $('depositAmount').focus(); showToast('Focus deposit amount'); }
  if(e.key==='w'){ $('withdrawAmount').focus(); showToast('Focus withdraw amount'); }
  if((e.ctrlKey||e.metaKey) && e.key==='k'){ e.preventDefault(); $('noteFilter').focus(); }
});

// ----------------- Small safety: remove emoji glyphs from headings/buttons if present -----------------
function stripEmojis(){
  document.querySelectorAll('h1,h3,button,label,option').forEach(el=>{
    if(!el || !el.textContent) return;
    const cleaned = el.textContent.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|\uFE0F|\u200D)/g,'').trim();
    if(cleaned !== el.textContent) el.textContent = cleaned;
  });
}
stripEmojis();

// expose state for developer convenience (remove in final production)
window.__bitshade_state = state;

</script>
</body>
</html>
